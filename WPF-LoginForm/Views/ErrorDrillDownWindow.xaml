<Window x:Class="WPF_LoginForm.Views.ErrorDrillDownWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:fa="http://schemas.awesome.incremented/wpf/xaml/fontawesome.sharp"
        mc:Ignorable="d"
        Title="{Binding WindowTitle}"
        Height="650" Width="950"
        WindowStartupLocation="CenterOwner"
        Background="{StaticResource AppBackgroundBrush}">

    <Window.Resources>
        <!-- SCROLLBAR STYLE -->
        <Style TargetType="ScrollBar">
            <Setter Property="Background" Value="{StaticResource InputBackgroundBrush}" />
        </Style>

        <!-- DATAGRID HEADER -->
        <Style TargetType="DataGridColumnHeader">
            <Setter Property="Background" Value="{StaticResource PrimaryAccentBrush}" />
            <Setter Property="Foreground" Value="{StaticResource TextPrimaryBrush}" />
            <Setter Property="FontWeight" Value="Bold" />
            <Setter Property="Padding" Value="10,8" />
            <Setter Property="HorizontalContentAlignment" Value="Left" />
            <Setter Property="BorderBrush" Value="{StaticResource HighlightBrush}" />
            <Setter Property="BorderThickness" Value="0,0,1,0" />
        </Style>

        <!-- DATAGRID ROW -->
        <Style TargetType="DataGridRow">
            <Setter Property="Background" Value="{StaticResource RowBackgroundBrush}" />
            <Setter Property="Foreground" Value="#E0E0E0" />
            <Setter Property="BorderThickness" Value="0,0,0,1" />
            <Setter Property="BorderBrush" Value="{StaticResource GridLineBrush}" />
            <Style.Triggers>
                <Trigger Property="IsMouseOver" Value="True">
                    <Setter Property="Background" Value="{StaticResource InputBackgroundBrush}" />
                </Trigger>
                <Trigger Property="IsSelected" Value="True">
                    <Setter Property="Background" Value="{StaticResource HighlightBrush}" />
                    <Setter Property="Foreground" Value="{StaticResource TextPrimaryBrush}" />
                </Trigger>
            </Style.Triggers>
        </Style>

        <!-- BUTTON STYLE -->
        <Style TargetType="Button">
            <Setter Property="Background" Value="{StaticResource PrimaryAccentBrush}" />
            <Setter Property="Foreground" Value="{StaticResource TextPrimaryBrush}" />
            <Setter Property="Padding" Value="15,6" />
            <Setter Property="BorderThickness" Value="0" />
            <Setter Property="FontWeight" Value="SemiBold" />
            <Setter Property="Cursor" Value="Hand" />
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border Background="{TemplateBinding Background}" CornerRadius="4">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center" Margin="{TemplateBinding Padding}" />
                        </Border>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
            <Style.Triggers>
                <Trigger Property="IsMouseOver" Value="True">
                    <Setter Property="Background" Value="{StaticResource PrimaryHoverBrush}" />
                </Trigger>
            </Style.Triggers>
        </Style>

        <!-- CHIP STYLE (The Filter Boxes) -->
        <Style x:Key="FilterChipStyle" TargetType="Border">
            <Setter Property="Background" Value="{StaticResource SecondaryAccentBrush}" />
            <Setter Property="CornerRadius" Value="15" />
            <Setter Property="Padding" Value="10,4,10,4" />
            <Setter Property="Margin" Value="0,0,8,0" />
        </Style>
    </Window.Resources>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <!-- Title -->
            <RowDefinition Height="Auto" />
            <!-- Active Filters (Chips) -->
            <RowDefinition Height="Auto" />
            <!-- Combo Selector -->
            <RowDefinition Height="*" />
            <!-- Grid -->
            <RowDefinition Height="Auto" />
            <!-- Footer -->
        </Grid.RowDefinitions>

        <!-- 1. HEADER -->
        <Border Grid.Row="0" Background="{StaticResource PanelBackgroundBrush}" Padding="20,15">
            <DockPanel>
                <fa:IconImage Icon="Filter" Foreground="{StaticResource PrimaryAccentBrush}" Height="24" Margin="0,0,10,0" />
                <StackPanel>
                    <TextBlock Text="{Binding WindowTitle}" FontSize="18" FontWeight="Bold" Foreground="{StaticResource TextPrimaryBrush}" />
                    <TextBlock Text="Detailed Error Analysis" FontSize="12" Foreground="{StaticResource TextMutedBrush}" />
                </StackPanel>
            </DockPanel>
        </Border>

        <!-- 2. ACTIVE FILTERS (CHIPS) -->
        <ItemsControl Grid.Row="1" ItemsSource="{Binding ActiveFilters}" Margin="20,15,20,5">
            <ItemsControl.ItemsPanel>
                <ItemsPanelTemplate>
                    <WrapPanel Orientation="Horizontal" />
                </ItemsPanelTemplate>
            </ItemsControl.ItemsPanel>
            <ItemsControl.ItemTemplate>
                <DataTemplate>
                    <Border Style="{StaticResource FilterChipStyle}">
                        <StackPanel Orientation="Horizontal">
                            <TextBlock Text="{Binding Label}" Foreground="{StaticResource TextPrimaryBrush}" FontWeight="SemiBold" VerticalAlignment="Center" />

                            <!-- X Button to Remove -->
                            <Button Command="{Binding DataContext.RemoveFilterChipCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                    CommandParameter="{Binding}"
                                    Margin="8,0,0,0"
                                    Background="Transparent"
                                    Foreground="{StaticResource TextPrimaryBrush}"
                                    Padding="2"
                                    Cursor="Hand">
                                <Button.Template>
                                    <ControlTemplate TargetType="Button">
                                        <Border Background="Transparent">
                                            <fa:IconImage Icon="TimesCircle" Width="14" Height="14" Foreground="{StaticResource TextPrimaryBrush}" Opacity="0.8" />
                                        </Border>
                                    </ControlTemplate>
                                </Button.Template>
                            </Button>
                        </StackPanel>
                    </Border>
                </DataTemplate>
            </ItemsControl.ItemTemplate>
        </ItemsControl>

        <!-- 3. ADDITIONAL SELECTOR -->
        <Border Grid.Row="2" Padding="20,5,20,15">
            <StackPanel Orientation="Horizontal">
                <TextBlock Text="Add Machine:" Foreground="{StaticResource TextSecondaryBrush}" VerticalAlignment="Center" Margin="0,0,10,0" />

                <ComboBox Width="200"
                          ItemsSource="{Binding MachineFilterList}"
                          StaysOpenOnEdit="True"
                          IsEditable="True"
                          IsReadOnly="True"
                          Text="-- Select --"
                          Background="{StaticResource InputBackgroundBrush}"
                          Foreground="Black">
                    <ComboBox.ItemTemplate>
                        <DataTemplate>
                            <CheckBox Content="{Binding Name}" IsChecked="{Binding IsChecked}" Margin="5" />
                        </DataTemplate>
                    </ComboBox.ItemTemplate>
                </ComboBox>

                <Button Content="Add to Filter" Command="{Binding ApplyFilterCommand}" Margin="10,0,0,0"
                        Background="{StaticResource PanelBackgroundBrush}"
                        BorderBrush="{StaticResource TextMutedBrush}"
                        BorderThickness="1" />
            </StackPanel>
        </Border>

        <!-- 4. DATA GRID -->
        <DataGrid Grid.Row="3"
                  ItemsSource="{Binding DisplayedItems}"
                  AutoGenerateColumns="False"
                  CanUserAddRows="False"
                  IsReadOnly="True"
                  GridLinesVisibility="Horizontal"
                  HorizontalGridLinesBrush="{StaticResource InputBackgroundBrush}"
                  VerticalGridLinesBrush="Transparent"
                  RowHeight="35"
                  Background="{StaticResource AppBackgroundBrush}"
                  BorderThickness="0"
                  Margin="20,0,20,10">

            <DataGrid.Columns>
                <!-- Date -->
                <DataGridTextColumn Header="Date" Binding="{Binding Date, StringFormat=dd.MM.yyyy}" Width="100" Foreground="{StaticResource TextPrimaryBrush}" />

                <!-- Shift -->
                <DataGridTextColumn Header="Shift" Binding="{Binding Shift}" Width="60" Foreground="{StaticResource TextSecondaryBrush}" />

                <!-- Machine -->
                <DataGridTextColumn Header="Machine" Binding="{Binding MachineCode}" Width="90" FontWeight="Bold" Foreground="{StaticResource HighlightBrush}" />

                <!-- Timeline -->
                <DataGridTextColumn Header="Timeline"
                                    Binding="{Binding TimeRange}"
                                    SortMemberPath="StartTime"
                                    Width="120"
                                    Foreground="{StaticResource TextPrimaryBrush}" />

                <!-- Duration -->
                <DataGridTextColumn Header="Duration"
                                    Binding="{Binding DurationText}"
                                    SortMemberPath="DurationMinutes"
                                    Width="90"
                                    Foreground="{StaticResource SuccessBrush}"
                                    FontWeight="Bold">
                    <DataGridTextColumn.ElementStyle>
                        <Style TargetType="TextBlock">
                            <Setter Property="HorizontalAlignment" Value="Right" />
                            <Setter Property="Padding" Value="0,0,15,0" />
                        </Style>
                    </DataGridTextColumn.ElementStyle>
                </DataGridTextColumn>

                <!-- Error -->
                <DataGridTextColumn Header="Description" Binding="{Binding ErrorMessage}" Width="*" Foreground="#DDD" />
            </DataGrid.Columns>
        </DataGrid>

        <!-- 5. FOOTER -->
        <Border Grid.Row="4" Background="{StaticResource SuccessBrush}" Padding="15">
            <Grid>
                <StackPanel Orientation="Horizontal" HorizontalAlignment="Left">
                    <TextBlock Text="Total Records:" FontWeight="Bold" Foreground="{StaticResource TextPrimaryBrush}" />
                    <TextBlock Text="{Binding RecordCount}" Margin="5,0,20,0" Foreground="{StaticResource TextPrimaryBrush}" />

                    <TextBlock Text="Total Downtime:" FontWeight="Bold" Foreground="{StaticResource TextPrimaryBrush}" />
                    <TextBlock Text="{Binding TotalDurationText}" Margin="5,0,0,0" Foreground="{StaticResource TextPrimaryBrush}" FontWeight="Bold" />
                </StackPanel>

                <Button Content="Close" Click="CloseButton_Click" HorizontalAlignment="Right" Width="100"
                        Background="Transparent" BorderBrush="White" BorderThickness="1" />
            </Grid>
        </Border>
    </Grid>
</Window>