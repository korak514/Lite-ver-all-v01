<UserControl x:Class="WPF_LoginForm.Views.ErrorManagementView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:lvc="clr-namespace:LiveCharts.Wpf;assembly=LiveCharts.Wpf"
             xmlns:xctk="http://schemas.xceed.com/wpf/xaml/toolkit"
             xmlns:p="clr-namespace:WPF_LoginForm.Properties"
             mc:Ignorable="d"
             d:DesignHeight="650" d:DesignWidth="1100">

    <Grid Background="#09092B">
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="2*" />
            <ColumnDefinition Width="3*" />
            <ColumnDefinition Width="260" />
            <!-- Slightly wider for better control spacing -->
        </Grid.ColumnDefinitions>

        <!-- COL 0: Left Column Charts -->
        <Grid Grid.Column="0" Margin="10">
            <Grid.RowDefinitions>
                <RowDefinition Height="*" />
                <RowDefinition Height="*" />
            </Grid.RowDefinitions>

            <!-- Top Pie: Overall Machine Distribution -->
            <Border Grid.Row="0" Margin="0,0,5,10" Background="#181838" CornerRadius="10" Padding="10">
                <Grid>
                    <TextBlock Text="{x:Static p:Resources.Chart_MachineDist}"
                               Foreground="LightGray" FontWeight="Bold" VerticalAlignment="Top" />

                    <lvc:PieChart Series="{Binding MachineSeries}" LegendLocation="Right" InnerRadius="0" Hoverable="True"
                                  DataClickCommand="{Binding ChartClickCommand}" Margin="0,25,0,0">
                        <lvc:PieChart.DataTooltip>
                            <lvc:DefaultTooltip SelectionMode="OnlySender" />
                        </lvc:PieChart.DataTooltip>
                        <lvc:PieChart.ChartLegend>
                            <lvc:DefaultLegend Foreground="#CCCCCC" FontSize="11" />
                        </lvc:PieChart.ChartLegend>
                    </lvc:PieChart>
                </Grid>
            </Border>

            <!-- Bottom Pie: Specific Error Machine Distribution -->
            <Border Grid.Row="1" Margin="0,0,5,0" Background="#181838" CornerRadius="10" Padding="10">
                <Grid>
                    <StackPanel Orientation="Vertical" VerticalAlignment="Top">
                        <TextBlock Text="{x:Static p:Resources.Chart_ShiftDist}" Foreground="LightGray" FontWeight="Bold" />
                        <TextBlock Text="{Binding SelectedErrorCategory}" Foreground="#FFC047" FontWeight="Bold" Margin="0,2,0,0" FontSize="11" />
                    </StackPanel>

                    <lvc:PieChart Series="{Binding ShiftSeries}" LegendLocation="Bottom" InnerRadius="40" Hoverable="True"
                                  DataClickCommand="{Binding ChartClickCommand}" Margin="0,35,0,0">
                        <lvc:PieChart.DataTooltip>
                            <lvc:DefaultTooltip SelectionMode="OnlySender" />
                        </lvc:PieChart.DataTooltip>
                        <lvc:PieChart.ChartLegend>
                            <lvc:DefaultLegend Foreground="#CCCCCC" FontSize="11" />
                        </lvc:PieChart.ChartLegend>
                    </lvc:PieChart>
                </Grid>
            </Border>
        </Grid>

        <!-- COL 1: Main Bar Chart -->
        <Border Grid.Column="1" Margin="5,10,5,10" Background="#181838" CornerRadius="10" Padding="15">
            <Grid>
                <TextBlock Text="{x:Static p:Resources.Chart_LongestIncident}"
                           Foreground="White" FontSize="16" FontWeight="SemiBold" />

                <lvc:CartesianChart Series="{Binding ReasonSeries}" LegendLocation="None" DataClickCommand="{Binding ChartClickCommand}" Margin="10,35,10,25">
                    <lvc:CartesianChart.AxisX>
                        <lvc:Axis Labels="{Binding ReasonLabels}" Foreground="White" FontSize="11">
                            <lvc:Axis.Separator>
                                <lvc:Separator Step="1" StrokeThickness="0" />
                            </lvc:Axis.Separator>
                        </lvc:Axis>
                    </lvc:CartesianChart.AxisX>
                    <lvc:CartesianChart.AxisY>
                        <lvc:Axis LabelFormatter="{Binding NumberFormatter}" Foreground="White">
                            <lvc:Axis.Separator>
                                <lvc:Separator Stroke="#303030" />
                            </lvc:Axis.Separator>
                        </lvc:Axis>
                    </lvc:CartesianChart.AxisY>
                </lvc:CartesianChart>
            </Grid>
        </Border>

        <!-- COL 2: Controls Panel (Right Side) -->
        <Border Grid.Column="2" Background="#101030" BorderBrush="#333" BorderThickness="1,0,0,0" Padding="15">
            <StackPanel>
                <TextBlock Text="{x:Static p:Resources.Ana_Title}"
                           Foreground="#0078D7" FontSize="18" FontWeight="Bold" Margin="0,0,0,20" TextWrapping="Wrap" />

                <!-- 1. Table Selector -->
                <TextBlock Text="{x:Static p:Resources.Ana_Table}" Foreground="Gray" Margin="0,0,0,5" />
                <ComboBox ItemsSource="{Binding TableNames}" SelectedItem="{Binding SelectedTable}"
                          Height="30" Margin="0,0,0,15" VerticalContentAlignment="Center" Padding="5" />

                <!-- 2. Error Category & Config Button -->
                <TextBlock Text="{x:Static p:Resources.Ana_Category}" Foreground="#FFC047" FontWeight="SemiBold" Margin="0,0,0,5" />

                <Grid Margin="0,0,0,10">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*" />
                        <ColumnDefinition Width="35" />
                    </Grid.ColumnDefinitions>

                    <ComboBox Grid.Column="0"
                              ItemsSource="{Binding ErrorCategories}"
                              SelectedItem="{Binding SelectedErrorCategory}"
                              Height="30" VerticalContentAlignment="Center" Padding="5"
                              ToolTip="Filter breakdown by this category." />

                    <!-- NEW CONFIG BUTTON -->
                    <Button Grid.Column="1"
                            Command="{Binding ConfigureCategoriesCommand}"
                            Content="⚙"
                            FontSize="16" Foreground="#AAA" Background="Transparent" BorderThickness="0"
                            ToolTip="{x:Static p:Resources.Str_CategoryConfig}"
                            Cursor="Hand" Margin="5,0,0,0" />
                </Grid>

                <CheckBox Content="{x:Static p:Resources.Ana_ExcludeMachine00}"
                          IsChecked="{Binding IsMachine00Excluded}"
                          Foreground="WhiteSmoke"
                          Margin="0,5,0,20"
                          ToolTip="Hides generic stops (MA-00)" />

                <!-- 3. Start Date Picker -->
                <TextBlock Text="{x:Static p:Resources.Ana_StartDate}" Foreground="Gray" Margin="0,0,0,5" />
                <Grid Margin="0,0,0,15">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="25" />
                        <ColumnDefinition Width="25" />
                        <ColumnDefinition Width="*" />
                        <ColumnDefinition Width="25" />
                        <ColumnDefinition Width="25" />
                    </Grid.ColumnDefinitions>
                    <Button Grid.Column="0" Content="&lt;&lt;" Command="{Binding MoveDateCommand}" CommandParameter="Start|-7" Background="#333" Foreground="White" BorderThickness="0" Cursor="Hand" />
                    <Button Grid.Column="1" Content="&lt;" Command="{Binding MoveDateCommand}" CommandParameter="Start|-1" Background="#444" Foreground="White" BorderThickness="0" Cursor="Hand" />
                    <DatePicker Grid.Column="2" SelectedDate="{Binding StartDate}" VerticalContentAlignment="Center" />
                    <Button Grid.Column="3" Content="&gt;" Command="{Binding MoveDateCommand}" CommandParameter="Start|1" Background="#444" Foreground="White" BorderThickness="0" Cursor="Hand" />
                    <Button Grid.Column="4" Content="&gt;&gt;" Command="{Binding MoveDateCommand}" CommandParameter="Start|7" Background="#333" Foreground="White" BorderThickness="0" Cursor="Hand" />
                </Grid>

                <!-- 4. End Date Picker -->
                <TextBlock Text="{x:Static p:Resources.Ana_EndDate}" Foreground="Gray" Margin="0,0,0,5" />
                <Grid Margin="0,0,0,20">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="25" />
                        <ColumnDefinition Width="25" />
                        <ColumnDefinition Width="*" />
                        <ColumnDefinition Width="25" />
                        <ColumnDefinition Width="25" />
                    </Grid.ColumnDefinitions>
                    <Button Grid.Column="0" Content="&lt;&lt;" Command="{Binding MoveDateCommand}" CommandParameter="End|-7" Background="#333" Foreground="White" BorderThickness="0" Cursor="Hand" />
                    <Button Grid.Column="1" Content="&lt;" Command="{Binding MoveDateCommand}" CommandParameter="End|-1" Background="#444" Foreground="White" BorderThickness="0" Cursor="Hand" />
                    <DatePicker Grid.Column="2" SelectedDate="{Binding EndDate}" VerticalContentAlignment="Center" />
                    <Button Grid.Column="3" Content="&gt;" Command="{Binding MoveDateCommand}" CommandParameter="End|1" Background="#444" Foreground="White" BorderThickness="0" Cursor="Hand" />
                    <Button Grid.Column="4" Content="&gt;&gt;" Command="{Binding MoveDateCommand}" CommandParameter="End|7" Background="#333" Foreground="White" BorderThickness="0" Cursor="Hand" />
                </Grid>

                <TextBlock Text="Range Slider:" Foreground="Gray" Margin="0,0,0,10" />
                <xctk:RangeSlider Minimum="{Binding SliderMinimum}" Maximum="{Binding SliderMaximum}"
                                  LowerValue="{Binding SliderLowValue}" HigherValue="{Binding SliderHighValue}"
                                  Height="30" Margin="0,0,0,25" />

                <!-- 5. Refresh Button -->
                <Button Content="{x:Static p:Resources.Ana_LoadData}"
                        Command="{Binding LoadDataCommand}"
                        Height="45" Background="#FF0078D7" Foreground="White"
                        FontWeight="Bold" FontSize="14" BorderThickness="0" Cursor="Hand">
                    <Button.Resources>
                        <Style TargetType="Border">
                            <Setter Property="CornerRadius" Value="5" />
                        </Style>
                    </Button.Resources>
                </Button>

                <TextBlock Text="* Drill-down enabled on charts." Foreground="#666" FontSize="11" TextWrapping="Wrap" Margin="0,20,0,0" FontStyle="Italic" HorizontalAlignment="Center" />
            </StackPanel>
        </Border>
    </Grid>
</UserControl>