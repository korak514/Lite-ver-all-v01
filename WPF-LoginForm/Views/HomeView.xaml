<!-- Views/HomeView.xaml -->
<UserControl x:Class="WPF_LoginForm.Views.HomeView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:local="clr-namespace:WPF_LoginForm.Views"
             xmlns:viewModels="clr-namespace:WPF_LoginForm.ViewModels"
             xmlns:lvc="clr-namespace:LiveCharts.Wpf;assembly=LiveCharts.Wpf"
             xmlns:fa="http://schemas.fontawesome.io/icons/"
             xmlns:xctk="http://schemas.xceed.com/wpf/xaml/toolkit"
             xmlns:converters="clr-namespace:WPF_LoginForm.Converters"
             xmlns:p="clr-namespace:WPF_LoginForm.Properties"
             mc:Ignorable="d"
             d:DesignHeight="600" d:DesignWidth="1000"
             d:DataContext="{d:DesignInstance Type=viewModels:HomeViewModel, IsDesignTimeCreatable=False}">

    <UserControl.Resources>
        <converters:BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter" />

        <!-- FIX 1: This property ensures that hovering over a pie chart only shows the tooltip for THAT slice -->
        <Style TargetType="lvc:DefaultTooltip">
            <Setter Property="Background" Value="#E6000030" />
            <Setter Property="Foreground" Value="WhiteSmoke" />
            <Setter Property="BorderBrush" Value="#80FFFFFF" />
            <Setter Property="BorderThickness" Value="1" />
            <Setter Property="CornerRadius" Value="6" />
            <Setter Property="Padding" Value="12,10" />
            <Setter Property="FontWeight" Value="SemiBold" />
            <Setter Property="SelectionMode" Value="OnlySender" />
        </Style>

        <Style x:Key="GearToggleStyle" TargetType="ToggleButton">
            <Setter Property="Background" Value="Transparent" />
            <Setter Property="BorderThickness" Value="0" />
            <Setter Property="Foreground" Value="WhiteSmoke" />
            <Setter Property="Cursor" Value="Hand" />
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="ToggleButton">
                        <Border Background="{TemplateBinding Background}">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center" />
                        </Border>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
            <Style.Triggers>
                <Trigger Property="IsMouseOver" Value="True">
                    <Setter Property="Foreground" Value="#FFC047" />
                </Trigger>
                <Trigger Property="IsChecked" Value="True">
                    <Setter Property="Foreground" Value="#FFC047" />
                </Trigger>
            </Style.Triggers>
        </Style>

        <Style x:Key="ManualMaximizeButtonStyle" TargetType="Button">
            <Setter Property="Background" Value="#99000000" />
            <Setter Property="Foreground" Value="White" />
            <Setter Property="BorderThickness" Value="0" />
            <Setter Property="Padding" Value="10,5" />
            <Setter Property="Cursor" Value="Hand" />
            <Setter Property="Visibility" Value="Collapsed" />
            <Setter Property="Margin" Value="5" />
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border Background="{TemplateBinding Background}" CornerRadius="4">
                            <StackPanel Orientation="Horizontal" Margin="{TemplateBinding Padding}">
                                <fa:ImageAwesome Icon="Expand" Height="12" Foreground="White" Margin="0,0,5,0" />
                                <TextBlock Text="Fullscreen" VerticalAlignment="Center" />
                            </StackPanel>
                        </Border>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
            <Style.Triggers>
                <DataTrigger Binding="{Binding ShowMaximizeButtons}" Value="True">
                    <Setter Property="Visibility" Value="Visible" />
                </DataTrigger>
                <DataTrigger Binding="{Binding IsAnyChartMaximized}" Value="True">
                    <Setter Property="Visibility" Value="Collapsed" />
                </DataTrigger>
                <Trigger Property="IsMouseOver" Value="True">
                    <Setter Property="Background" Value="#FFC047" />
                    <Setter Property="Foreground" Value="Black" />
                </Trigger>
            </Style.Triggers>
        </Style>

        <Style x:Key="CloseMaximizeButtonStyle" TargetType="Button">
            <Setter Property="Background" Value="#D14545" />
            <Setter Property="Foreground" Value="White" />
            <Setter Property="BorderThickness" Value="0" />
            <Setter Property="Padding" Value="10,6" />
            <Setter Property="Cursor" Value="Hand" />
            <Setter Property="Visibility" Value="Collapsed" />
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border Background="{TemplateBinding Background}" CornerRadius="4">
                            <StackPanel Orientation="Horizontal" Margin="{TemplateBinding Padding}">
                                <fa:ImageAwesome Icon="Compress" Height="14" Foreground="White" Margin="0,0,6,0" />
                                <TextBlock Text="Close" FontSize="13" FontWeight="Bold" VerticalAlignment="Center" />
                            </StackPanel>
                        </Border>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
            <Style.Triggers>
                <Trigger Property="IsMouseOver" Value="True">
                    <Setter Property="Background" Value="#B03030" />
                </Trigger>
            </Style.Triggers>
        </Style>
    </UserControl.Resources>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
        </Grid.RowDefinitions>

        <!-- Top Control Bar -->
        <Grid Grid.Row="0" Margin="5,5,10,5">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*" />
                <ColumnDefinition Width="Auto" />
            </Grid.ColumnDefinitions>

            <StackPanel Grid.Column="0" Orientation="Vertical" Visibility="{Binding IsDateFilterVisible, Converter={StaticResource BooleanToVisibilityConverter}}">
                <StackPanel Orientation="Horizontal" HorizontalAlignment="Left" Margin="0,0,0,10">
                    <Button Command="{Binding GoBackCommand}" ToolTip="Return to Analytics Hub" Background="Transparent" BorderThickness="0" Margin="0,0,15,0" Cursor="Hand">
                        <StackPanel Orientation="Horizontal">
                            <fa:ImageAwesome Icon="ArrowLeft" Height="14" Foreground="#FFC047" Margin="0,0,5,0" />
                            <TextBlock Text="Hub" Foreground="#FFC047" FontWeight="Bold" VerticalAlignment="Center" />
                        </StackPanel>
                    </Button>

                    <ToggleButton IsChecked="{Binding ShowMaximizeButtons}" Style="{StaticResource GearToggleStyle}" Margin="0,0,15,0" ToolTip="Toggle Fullscreen Buttons">
                        <fa:ImageAwesome Icon="ArrowsAlt" Height="16" Foreground="{Binding Foreground, RelativeSource={RelativeSource AncestorType=ToggleButton}}" />
                    </ToggleButton>

                    <StackPanel Orientation="Horizontal" IsEnabled="{Binding IsFilterByDate}">
                        <TextBlock Text="Start:" VerticalAlignment="Center" Margin="0,0,5,0" Foreground="WhiteSmoke" />
                        <DatePicker SelectedDate="{Binding StartDate, Mode=TwoWay}" VerticalAlignment="Center" Width="100" />
                        <TextBlock Text="End:" VerticalAlignment="Center" Margin="10,0,5,0" Foreground="WhiteSmoke" />
                        <DatePicker SelectedDate="{Binding EndDate, Mode=TwoWay}" VerticalAlignment="Center" Width="100" />
                    </StackPanel>

                    <ToggleButton x:Name="FilterConfigToggle" Margin="15,0,0,0" ToolTip="Filter Settings" Style="{StaticResource GearToggleStyle}">
                        <fa:ImageAwesome Icon="Gear" Height="16" Foreground="{Binding Foreground, RelativeSource={RelativeSource AncestorType=ToggleButton}}" />
                    </ToggleButton>

                    <ComboBox ItemsSource="{Binding DashboardFiles}" SelectedItem="{Binding SelectedDashboardFile, Mode=TwoWay}" Width="150" Height="22" Margin="15,0,0,0" Visibility="{Binding IsDashboardSelectorVisible, Converter={StaticResource BooleanToVisibilityConverter}}" />

                    <Button Command="{Binding TogglePageCommand}" Width="30" Height="22" Margin="15,0,0,0" Background="Transparent" BorderThickness="0" Cursor="Hand" ToolTip="Switch to Advanced Summary">
                        <Grid>
                            <Path Fill="#FFC047" Data="M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M16.59,12L15,13.41L12,10.41L9,13.41L7.41,12L12,7.41L16.59,12Z">
                                <Path.Style>
                                    <Style TargetType="Path">
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding IsSecondPageActive}" Value="True">
                                                <Setter Property="RenderTransform">
                                                    <Setter.Value>
                                                        <RotateTransform Angle="180" CenterX="12" CenterY="12" />
                                                    </Setter.Value>
                                                </Setter>
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </Path.Style>
                            </Path>
                        </Grid>
                    </Button>

                    <Popup IsOpen="{Binding IsChecked, ElementName=FilterConfigToggle}" StaysOpen="False" PlacementTarget="{Binding ElementName=FilterConfigToggle}" Placement="Bottom">
                        <Border Background="#030347" BorderBrush="#49A956" BorderThickness="1" CornerRadius="4" Padding="10">
                            <StackPanel MinWidth="220">
                                <TextBlock Text="Label Settings (Global)" Foreground="Gray" FontSize="10" Margin="0,0,0,5" />
                                <CheckBox Content="On label ignore after '-'" IsChecked="{Binding GlobalIgnoreAfterHyphen, Mode=TwoWay}" Foreground="WhiteSmoke" Margin="0,0,0,8" ToolTip="Truncates text after the hyphen to prevent overlaps." />

                                <Separator Background="#49A956" Margin="0,5,0,5" />

                                <TextBlock Text="Filter Mode" Foreground="Gray" FontSize="10" Margin="0,0,0,5" />
                                <CheckBox Content="Filter by Date" IsChecked="{Binding IsFilterByDate, Mode=TwoWay}" Foreground="WhiteSmoke" Margin="0,0,0,8" />
                                <CheckBox Content="Ignore Rows with No Date" IsChecked="{Binding IgnoreNonDateData, Mode=TwoWay}" Foreground="WhiteSmoke" Margin="0,0,0,8" />

                                <Separator Background="#49A956" Margin="0,5,0,5" />

                                <TextBlock Text="Virtual Date (ID to Date)" Foreground="Gray" FontSize="10" Margin="0,0,0,5" />
                                <CheckBox Content="Use Initial Date for Drill-Down" IsChecked="{Binding UseIdToDateConversion, Mode=TwoWay}" Foreground="WhiteSmoke" Margin="0,0,0,5" />
                                <StackPanel Orientation="Horizontal" IsEnabled="{Binding UseIdToDateConversion}">
                                    <TextBlock Text="Initial Date:" Foreground="WhiteSmoke" VerticalAlignment="Center" Margin="0,0,10,0" FontSize="11" />
                                    <DatePicker SelectedDate="{Binding InitialDateForConversion, Mode=TwoWay}" Width="100" />
                                </StackPanel>

                                <Separator Background="#49A956" Margin="0,10,0,5" />

                                <TextBlock Text="Slider Tick Step" Foreground="Gray" FontSize="10" Margin="0,0,0,5" />
                                <ComboBox ItemsSource="{Binding TickOptions}" SelectedValuePath="Value" DisplayMemberPath="Label" SelectedValue="{Binding SliderTickFrequency, Mode=TwoWay}" Height="26" Margin="0,0,0,5" />
                            </StackPanel>
                        </Border>
                    </Popup>
                </StackPanel>

                <StackPanel Orientation="Horizontal" HorizontalAlignment="Left">
                    <TextBlock Text="Range:" VerticalAlignment="Center" Margin="0,0,5,0" Foreground="WhiteSmoke" />
                    <xctk:RangeSlider MinWidth="450" VerticalAlignment="Center" Minimum="0" Maximum="{Binding SliderMaximum}" LowerValue="{Binding StartMonthSliderValue, Mode=TwoWay}" HigherValue="{Binding EndMonthSliderValue, Mode=TwoWay}" IsSnapToTickEnabled="True" TickFrequency="{Binding SliderTickFrequency}" AutoToolTipPlacement="TopLeft" AutoToolTipPrecision="0" />
                </StackPanel>
            </StackPanel>

            <StackPanel Grid.Column="1" Orientation="Horizontal" HorizontalAlignment="Right" VerticalAlignment="Center">
                <CheckBox Content="Include Data in Export" IsChecked="{Binding IsSnapshotExport, Mode=TwoWay}" Foreground="WhiteSmoke" VerticalAlignment="Center" Margin="0,0,15,0" />
                <Button Content="Import" Margin="5,0,5,0" Padding="8,4" Command="{Binding ImportCommand}" />
                <Button Content="Export" Margin="5,0,5,0" Padding="8,4" Command="{Binding ExportCommand}" />
                <Button ToolTip="Recolor Charts" Margin="5,0,5,0" Padding="8,4" Command="{Binding RecolorChartsCommand}">
                    <fa:ImageAwesome Icon="PaintBrush" Height="14" Foreground="White" />
                </Button>
                <Button Content="" FontFamily="Segoe MDL2 Assets" Margin="5,0,0,0" Padding="8,4" Command="{Binding ConfigureCommand}" />
            </StackPanel>
        </Grid>

        <Grid Grid.Row="1">
            <!-- PAGE 1 -->
            <Grid x:Name="Page1" RenderTransformOrigin="0.5,0.5">
                <Grid.Style>
                    <Style TargetType="Grid">
                        <Style.Triggers>
                            <DataTrigger Binding="{Binding IsSecondPageActive}" Value="True">
                                <DataTrigger.EnterActions>
                                    <BeginStoryboard>
                                        <Storyboard>
                                            <DoubleAnimation Storyboard.TargetProperty="Opacity" To="0" Duration="0:0:0.4" />
                                            <ObjectAnimationUsingKeyFrames Storyboard.TargetProperty="Visibility" BeginTime="0:0:0.4">
                                                <DiscreteObjectKeyFrame KeyTime="0:0:0" Value="{x:Static Visibility.Collapsed}" />
                                            </ObjectAnimationUsingKeyFrames>
                                        </Storyboard>
                                    </BeginStoryboard>
                                </DataTrigger.EnterActions>
                                <DataTrigger.ExitActions>
                                    <BeginStoryboard>
                                        <Storyboard>
                                            <ObjectAnimationUsingKeyFrames Storyboard.TargetProperty="Visibility">
                                                <DiscreteObjectKeyFrame KeyTime="0:0:0" Value="{x:Static Visibility.Visible}" />
                                            </ObjectAnimationUsingKeyFrames>
                                            <DoubleAnimation Storyboard.TargetProperty="Opacity" To="1" Duration="0:0:0.4" />
                                        </Storyboard>
                                    </BeginStoryboard>
                                </DataTrigger.ExitActions>
                            </DataTrigger>
                        </Style.Triggers>
                    </Style>
                </Grid.Style>

                <Grid.RowDefinitions>
                    <RowDefinition Height="*" />
                    <RowDefinition Height="*" />
                </Grid.RowDefinitions>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="*" />
                </Grid.ColumnDefinitions>

                <Border Background="#CC000000" Panel.ZIndex="50" Grid.RowSpan="2" Grid.ColumnSpan="3" Cursor="Hand" Visibility="{Binding IsAnyChartMaximized, Converter={StaticResource BooleanToVisibilityConverter}}">
                    <Border.InputBindings>
                        <MouseBinding MouseAction="LeftClick" Command="{Binding CloseMaximizeCommand}" />
                    </Border.InputBindings>
                </Border>

                <!-- CHART 1 -->
                <Grid>
                    <Grid.Style>
                        <Style TargetType="Grid">
                            <Setter Property="Grid.Row" Value="0" />
                            <Setter Property="Grid.Column" Value="0" />
                            <Setter Property="Grid.RowSpan" Value="1" />
                            <Setter Property="Grid.ColumnSpan" Value="1" />
                            <Setter Property="Panel.ZIndex" Value="1" />
                            <Setter Property="Margin" Value="5" />
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding MaximizedChartIndex}" Value="1">
                                    <Setter Property="Grid.Row" Value="0" />
                                    <Setter Property="Grid.Column" Value="0" />
                                    <Setter Property="Grid.RowSpan" Value="2" />
                                    <Setter Property="Grid.ColumnSpan" Value="3" />
                                    <Setter Property="Panel.ZIndex" Value="100" />
                                    <Setter Property="Margin" Value="100,40" />
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </Grid.Style>
                    <Border Background="#181838" CornerRadius="10" Padding="15">
                        <Border.ContextMenu>
                            <ContextMenu>
                                <MenuItem Header="Copy Chart Image" Command="{Binding DataContext.CopyImageCommand, RelativeSource={RelativeSource AncestorType=UserControl}}" CommandParameter="{Binding PlacementTarget, RelativeSource={RelativeSource AncestorType=ContextMenu}}" />
                                <MenuItem Header="Export Chart Data (CSV)" Command="{Binding DataContext.ExportChartDataCommand, RelativeSource={RelativeSource AncestorType=UserControl}}" CommandParameter="1" />
                            </ContextMenu>
                        </Border.ContextMenu>
                        <Grid>
                            <lvc:CartesianChart Series="{Binding Chart1Series}" DataClickCommand="{Binding ChartClickCommand}" LegendLocation="Bottom" AxisX="{Binding Chart1X}" AxisY="{Binding Chart1Y}" Foreground="WhiteSmoke" />
                            <Button Command="{Binding MaximizeChartCommand}" CommandParameter="1" HorizontalAlignment="Right" VerticalAlignment="Top" Style="{StaticResource ManualMaximizeButtonStyle}" />
                            <Button Command="{Binding CloseMaximizeCommand}" HorizontalAlignment="Right" VerticalAlignment="Top" Margin="10">
                                <Button.Style>
                                    <Style TargetType="Button" BasedOn="{StaticResource CloseMaximizeButtonStyle}">
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding MaximizedChartIndex}" Value="1">
                                                <Setter Property="Visibility" Value="Visible" />
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </Button.Style>
                            </Button>
                        </Grid>
                    </Border>
                </Grid>

                <!-- CHART 2 -->
                <Grid>
                    <Grid.Style>
                        <Style TargetType="Grid">
                            <Setter Property="Grid.Row" Value="0" />
                            <Setter Property="Grid.Column" Value="1" />
                            <Setter Property="Grid.RowSpan" Value="1" />
                            <Setter Property="Grid.ColumnSpan" Value="1" />
                            <Setter Property="Panel.ZIndex" Value="1" />
                            <Setter Property="Margin" Value="5" />
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding MaximizedChartIndex}" Value="2">
                                    <Setter Property="Grid.Row" Value="0" />
                                    <Setter Property="Grid.Column" Value="0" />
                                    <Setter Property="Grid.RowSpan" Value="2" />
                                    <Setter Property="Grid.ColumnSpan" Value="3" />
                                    <Setter Property="Panel.ZIndex" Value="100" />
                                    <Setter Property="Margin" Value="100,40" />
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </Grid.Style>
                    <Border Background="#181838" CornerRadius="10" Padding="15">
                        <Border.ContextMenu>
                            <ContextMenu>
                                <MenuItem Header="Copy Chart Image" Command="{Binding DataContext.CopyImageCommand, RelativeSource={RelativeSource AncestorType=UserControl}}" CommandParameter="{Binding PlacementTarget, RelativeSource={RelativeSource AncestorType=ContextMenu}}" />
                                <MenuItem Header="Export Chart Data (CSV)" Command="{Binding DataContext.ExportChartDataCommand, RelativeSource={RelativeSource AncestorType=UserControl}}" CommandParameter="2" />
                            </ContextMenu>
                        </Border.ContextMenu>
                        <Grid>
                            <lvc:CartesianChart Series="{Binding Chart2Series}" DataClickCommand="{Binding ChartClickCommand}" LegendLocation="Bottom" AxisX="{Binding Chart2X}" AxisY="{Binding Chart2Y}" Foreground="WhiteSmoke" />
                            <Button Command="{Binding MaximizeChartCommand}" CommandParameter="2" HorizontalAlignment="Right" VerticalAlignment="Top" Style="{StaticResource ManualMaximizeButtonStyle}" />
                            <Button Command="{Binding CloseMaximizeCommand}" HorizontalAlignment="Right" VerticalAlignment="Top" Margin="10">
                                <Button.Style>
                                    <Style TargetType="Button" BasedOn="{StaticResource CloseMaximizeButtonStyle}">
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding MaximizedChartIndex}" Value="2">
                                                <Setter Property="Visibility" Value="Visible" />
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </Button.Style>
                            </Button>
                        </Grid>
                    </Border>
                </Grid>

                <!-- CHART 3 -->
                <Grid>
                    <Grid.Style>
                        <Style TargetType="Grid">
                            <Setter Property="Grid.Row" Value="0" />
                            <Setter Property="Grid.Column" Value="2" />
                            <Setter Property="Grid.RowSpan" Value="1" />
                            <Setter Property="Grid.ColumnSpan" Value="1" />
                            <Setter Property="Panel.ZIndex" Value="1" />
                            <Setter Property="Margin" Value="5" />
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding MaximizedChartIndex}" Value="3">
                                    <Setter Property="Grid.Row" Value="0" />
                                    <Setter Property="Grid.Column" Value="0" />
                                    <Setter Property="Grid.RowSpan" Value="2" />
                                    <Setter Property="Grid.ColumnSpan" Value="3" />
                                    <Setter Property="Panel.ZIndex" Value="100" />
                                    <Setter Property="Margin" Value="100,40" />
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </Grid.Style>
                    <Border Background="#181838" CornerRadius="10" Padding="15">
                        <Border.ContextMenu>
                            <ContextMenu>
                                <MenuItem Header="Copy Chart Image" Command="{Binding DataContext.CopyImageCommand, RelativeSource={RelativeSource AncestorType=UserControl}}" CommandParameter="{Binding PlacementTarget, RelativeSource={RelativeSource AncestorType=ContextMenu}}" />
                                <MenuItem Header="Export Chart Data (CSV)" Command="{Binding DataContext.ExportChartDataCommand, RelativeSource={RelativeSource AncestorType=UserControl}}" CommandParameter="3" />
                            </ContextMenu>
                        </Border.ContextMenu>
                        <Grid>
                            <lvc:CartesianChart Series="{Binding Chart3Series}" DataClickCommand="{Binding ChartClickCommand}" LegendLocation="Bottom" AxisX="{Binding Chart3X}" AxisY="{Binding Chart3Y}" Foreground="WhiteSmoke" />
                            <Button Command="{Binding MaximizeChartCommand}" CommandParameter="3" HorizontalAlignment="Right" VerticalAlignment="Top" Style="{StaticResource ManualMaximizeButtonStyle}" />
                            <Button Command="{Binding CloseMaximizeCommand}" HorizontalAlignment="Right" VerticalAlignment="Top" Margin="10">
                                <Button.Style>
                                    <Style TargetType="Button" BasedOn="{StaticResource CloseMaximizeButtonStyle}">
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding MaximizedChartIndex}" Value="3">
                                                <Setter Property="Visibility" Value="Visible" />
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </Button.Style>
                            </Button>
                        </Grid>
                    </Border>
                </Grid>

                <!-- FIX 2: Added Hoverable="True" explicitly to Pie Charts -->
                <!-- CHART 4 (PIE) -->
                <Grid>
                    <Grid.Style>
                        <Style TargetType="Grid">
                            <Setter Property="Grid.Row" Value="1" />
                            <Setter Property="Grid.Column" Value="0" />
                            <Setter Property="Grid.RowSpan" Value="1" />
                            <Setter Property="Grid.ColumnSpan" Value="1" />
                            <Setter Property="Panel.ZIndex" Value="1" />
                            <Setter Property="Margin" Value="5" />
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding MaximizedChartIndex}" Value="4">
                                    <Setter Property="Grid.Row" Value="0" />
                                    <Setter Property="Grid.Column" Value="0" />
                                    <Setter Property="Grid.RowSpan" Value="2" />
                                    <Setter Property="Grid.ColumnSpan" Value="3" />
                                    <Setter Property="Panel.ZIndex" Value="100" />
                                    <Setter Property="Margin" Value="100,40" />
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </Grid.Style>
                    <Border Background="#181838" CornerRadius="10" Padding="15">
                        <Border.ContextMenu>
                            <ContextMenu>
                                <MenuItem Header="Copy Chart Image" Command="{Binding DataContext.CopyImageCommand, RelativeSource={RelativeSource AncestorType=UserControl}}" CommandParameter="{Binding PlacementTarget, RelativeSource={RelativeSource AncestorType=ContextMenu}}" />
                                <MenuItem Header="Export Chart Data (CSV)" Command="{Binding DataContext.ExportChartDataCommand, RelativeSource={RelativeSource AncestorType=UserControl}}" CommandParameter="4" />
                            </ContextMenu>
                        </Border.ContextMenu>
                        <Grid>
                            <lvc:PieChart Series="{Binding Chart4Series}" DataClickCommand="{Binding ChartClickCommand}" LegendLocation="Right" Foreground="WhiteSmoke" Hoverable="True" />
                            <Button Command="{Binding MaximizeChartCommand}" CommandParameter="4" HorizontalAlignment="Right" VerticalAlignment="Top" Style="{StaticResource ManualMaximizeButtonStyle}" />
                            <Button Command="{Binding CloseMaximizeCommand}" HorizontalAlignment="Right" VerticalAlignment="Top" Margin="10">
                                <Button.Style>
                                    <Style TargetType="Button" BasedOn="{StaticResource CloseMaximizeButtonStyle}">
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding MaximizedChartIndex}" Value="4">
                                                <Setter Property="Visibility" Value="Visible" />
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </Button.Style>
                            </Button>
                        </Grid>
                    </Border>
                </Grid>

                <!-- CHART 5 -->
                <Grid>
                    <Grid.Style>
                        <Style TargetType="Grid">
                            <Setter Property="Grid.Row" Value="1" />
                            <Setter Property="Grid.Column" Value="1" />
                            <Setter Property="Grid.RowSpan" Value="1" />
                            <Setter Property="Grid.ColumnSpan" Value="2" />
                            <Setter Property="Panel.ZIndex" Value="1" />
                            <Setter Property="Margin" Value="5" />
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding MaximizedChartIndex}" Value="5">
                                    <Setter Property="Grid.Row" Value="0" />
                                    <Setter Property="Grid.Column" Value="0" />
                                    <Setter Property="Grid.RowSpan" Value="2" />
                                    <Setter Property="Grid.ColumnSpan" Value="3" />
                                    <Setter Property="Panel.ZIndex" Value="100" />
                                    <Setter Property="Margin" Value="100,40" />
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </Grid.Style>
                    <Border Background="#181838" CornerRadius="10" Padding="15">
                        <Border.ContextMenu>
                            <ContextMenu>
                                <MenuItem Header="Copy Chart Image" Command="{Binding DataContext.CopyImageCommand, RelativeSource={RelativeSource AncestorType=UserControl}}" CommandParameter="{Binding PlacementTarget, RelativeSource={RelativeSource AncestorType=ContextMenu}}" />
                                <MenuItem Header="Export Chart Data (CSV)" Command="{Binding DataContext.ExportChartDataCommand, RelativeSource={RelativeSource AncestorType=UserControl}}" CommandParameter="5" />
                            </ContextMenu>
                        </Border.ContextMenu>
                        <Grid>
                            <lvc:CartesianChart Series="{Binding Chart5Series}" DataClickCommand="{Binding ChartClickCommand}" LegendLocation="Bottom" AxisX="{Binding Chart5X}" AxisY="{Binding Chart5Y}" Foreground="WhiteSmoke" />
                            <Button Command="{Binding MaximizeChartCommand}" CommandParameter="5" HorizontalAlignment="Right" VerticalAlignment="Top" Style="{StaticResource ManualMaximizeButtonStyle}" />
                            <Button Command="{Binding CloseMaximizeCommand}" HorizontalAlignment="Right" VerticalAlignment="Top" Margin="10">
                                <Button.Style>
                                    <Style TargetType="Button" BasedOn="{StaticResource CloseMaximizeButtonStyle}">
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding MaximizedChartIndex}" Value="5">
                                                <Setter Property="Visibility" Value="Visible" />
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </Button.Style>
                            </Button>
                        </Grid>
                    </Border>
                </Grid>
            </Grid>

            <!-- PAGE 2 (Advanced View) -->
            <Grid x:Name="Page2" Visibility="Collapsed" RenderTransformOrigin="0.5,0.5">
                <Grid.Style>
                    <Style TargetType="Grid">
                        <Style.Triggers>
                            <DataTrigger Binding="{Binding IsSecondPageActive}" Value="True">
                                <DataTrigger.EnterActions>
                                    <BeginStoryboard>
                                        <Storyboard>
                                            <ObjectAnimationUsingKeyFrames Storyboard.TargetProperty="Visibility">
                                                <DiscreteObjectKeyFrame KeyTime="0:0:0" Value="{x:Static Visibility.Visible}" />
                                            </ObjectAnimationUsingKeyFrames>
                                            <DoubleAnimation Storyboard.TargetProperty="Opacity" From="0" To="1" Duration="0:0:0.5" />
                                            <ThicknessAnimation Storyboard.TargetProperty="Margin" From="50,0,0,0" To="0" Duration="0:0:0.4" DecelerationRatio="0.9" />
                                        </Storyboard>
                                    </BeginStoryboard>
                                </DataTrigger.EnterActions>
                                <DataTrigger.ExitActions>
                                    <BeginStoryboard>
                                        <Storyboard>
                                            <DoubleAnimation Storyboard.TargetProperty="Opacity" To="0" Duration="0:0:0.2" />
                                            <ObjectAnimationUsingKeyFrames Storyboard.TargetProperty="Visibility" BeginTime="0:0:0.2">
                                                <DiscreteObjectKeyFrame KeyTime="0:0:0" Value="{x:Static Visibility.Collapsed}" />
                                            </ObjectAnimationUsingKeyFrames>
                                        </Storyboard>
                                    </BeginStoryboard>
                                </DataTrigger.ExitActions>
                            </DataTrigger>
                        </Style.Triggers>
                    </Style>
                </Grid.Style>

                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="2.5*" />
                    <ColumnDefinition Width="1*" />
                </Grid.ColumnDefinitions>

                <Border Background="#CC000000" Panel.ZIndex="50" Grid.ColumnSpan="2" Cursor="Hand" Visibility="{Binding IsAnyChartMaximized, Converter={StaticResource BooleanToVisibilityConverter}}">
                    <Border.InputBindings>
                        <MouseBinding MouseAction="LeftClick" Command="{Binding CloseMaximizeCommand}" />
                    </Border.InputBindings>
                </Border>

                <!-- FIX 2: Added Hoverable="True" explicitly to Pie Charts -->
                <!-- CHART 6 (BIG PIE) -->
                <Grid>
                    <Grid.Style>
                        <Style TargetType="Grid">
                            <Setter Property="Grid.Row" Value="0" />
                            <Setter Property="Grid.Column" Value="0" />
                            <Setter Property="Grid.RowSpan" Value="1" />
                            <Setter Property="Grid.ColumnSpan" Value="1" />
                            <Setter Property="Panel.ZIndex" Value="1" />
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding MaximizedChartIndex}" Value="6">
                                    <Setter Property="Grid.Row" Value="0" />
                                    <Setter Property="Grid.Column" Value="0" />
                                    <Setter Property="Grid.RowSpan" Value="1" />
                                    <Setter Property="Grid.ColumnSpan" Value="2" />
                                    <Setter Property="Panel.ZIndex" Value="100" />
                                    <Setter Property="Margin" Value="100,40" />
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </Grid.Style>
                    <Border Background="#10FFFFFF" CornerRadius="10" Margin="10">
                        <Border.ContextMenu>
                            <ContextMenu>
                                <MenuItem Header="Copy Chart Image" Command="{Binding DataContext.CopyImageCommand, RelativeSource={RelativeSource AncestorType=UserControl}}" CommandParameter="{Binding PlacementTarget, RelativeSource={RelativeSource AncestorType=ContextMenu}}" />
                                <MenuItem Header="Export Chart Data (CSV)" Command="{Binding DataContext.ExportChartDataCommand, RelativeSource={RelativeSource AncestorType=UserControl}}" CommandParameter="6" />
                            </ContextMenu>
                        </Border.ContextMenu>
                        <Grid>
                            <TextBlock Text="Summary Breakdown (Chart 6)" Foreground="Gray" FontWeight="Bold" Margin="15,10,0,0" />
                            <lvc:PieChart Series="{Binding Chart6Series}" LegendLocation="Bottom" InnerRadius="80" Margin="20,40,20,20" Hoverable="True">
                                <lvc:PieChart.ChartLegend>
                                    <lvc:DefaultLegend Foreground="#CCCCCC" FontSize="13" />
                                </lvc:PieChart.ChartLegend>
                            </lvc:PieChart>
                            <Button Command="{Binding MaximizeChartCommand}" CommandParameter="6" HorizontalAlignment="Right" VerticalAlignment="Top" Margin="10" Style="{StaticResource ManualMaximizeButtonStyle}" />
                            <Button Command="{Binding CloseMaximizeCommand}" HorizontalAlignment="Right" VerticalAlignment="Top" Margin="10">
                                <Button.Style>
                                    <Style TargetType="Button" BasedOn="{StaticResource CloseMaximizeButtonStyle}">
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding MaximizedChartIndex}" Value="6">
                                                <Setter Property="Visibility" Value="Visible" />
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </Button.Style>
                            </Button>
                        </Grid>
                    </Border>
                </Grid>

                <Border Grid.Column="1" Margin="5,10,10,10" Background="Transparent" Panel.ZIndex="1">
                    <ScrollViewer VerticalScrollBarVisibility="Auto">
                        <ItemsControl ItemsSource="{Binding KpiCards}">
                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <Border Background="#181838" CornerRadius="8" Margin="0,0,0,10" Padding="15">
                                        <Border.Effect>
                                            <DropShadowEffect Color="Black" BlurRadius="5" Opacity="0.3" ShadowDepth="2" />
                                        </Border.Effect>
                                        <Grid>
                                            <Grid.RowDefinitions>
                                                <RowDefinition Height="Auto" />
                                                <RowDefinition Height="Auto" />
                                            </Grid.RowDefinitions>
                                            <TextBlock Grid.Row="0" Text="{Binding Title}" Foreground="Gray" FontSize="12" FontWeight="SemiBold" TextWrapping="Wrap" />
                                            <StackPanel Orientation="Horizontal" Grid.Row="1">
                                                <TextBlock Text="{Binding Value}" Foreground="{Binding ColorHex}" FontSize="24" FontWeight="Bold" Margin="0,5,10,0" />
                                                <Border Background="#10FFFFFF" CornerRadius="4" Padding="5,2" VerticalAlignment="Center">
                                                    <TextBlock Text="{Binding TrendIcon}" Foreground="{Binding TrendColor}" FontSize="12" FontWeight="Bold" />
                                                </Border>
                                            </StackPanel>
                                        </Grid>
                                    </Border>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                    </ScrollViewer>
                </Border>
            </Grid>
        </Grid>
    </Grid>
</UserControl>