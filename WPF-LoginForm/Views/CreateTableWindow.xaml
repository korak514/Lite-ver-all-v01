<Window x:Class="WPF_LoginForm.Views.CreateTableWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:local="clr-namespace:WPF_LoginForm.Views"
        xmlns:viewModels="clr-namespace:WPF_LoginForm.ViewModels"
        xmlns:converters="clr-namespace:WPF_LoginForm.Converters"
        mc:Ignorable="d"
        d:DataContext="{d:DesignInstance Type=viewModels:CreateTableViewModel, IsDesignTimeCreatable=False}"
        Title="Create New Table from Excel"
        SizeToContent="Width" 
        Height="auto" MaxHeight="800" MinWidth="750"
        WindowStartupLocation="CenterOwner"
        ResizeMode="NoResize">

    <Window.Resources>
        <BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter"/>
    </Window.Resources>

    <Grid Margin="15">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <!-- For all top content -->
            <RowDefinition Height="*"/>
            <!-- For the schema grid (takes all remaining space) -->
            <RowDefinition Height="Auto"/>
            <!-- For the action buttons at the bottom -->
        </Grid.RowDefinitions>

        <!-- All top-level controls go in this StackPanel in the first row -->
        <StackPanel Grid.Row="0">
            <!-- Step 1: File Selection -->
            <GroupBox Header="Step 1: Select Excel File" Padding="10">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>
                    <TextBox Grid.Column="0" Text="{Binding FilePath}" IsReadOnly="True" VerticalContentAlignment="Center" Margin="0,0,5,0"/>
                    <Button Grid.Column="1" Content="Browse..." Command="{Binding BrowseCommand}" Padding="8,4" Margin="5,0,0,0"/>
                </Grid>
            </GroupBox>

            <!-- Step 2: Analysis Options (Worksheet, Header Row, etc.) -->
            <GroupBox Header="Step 2: Analysis Options" Padding="10" Margin="0,10,0,0"
                      Visibility="{Binding IsFileSelected, Converter={StaticResource BooleanToVisibilityConverter}}">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="*"/>
                    </Grid.ColumnDefinitions>

                    <Label Grid.Row="0" Grid.Column="0" Content="Worksheet:" VerticalAlignment="Center"/>
                    <ComboBox Grid.Row="0" Grid.Column="1" Margin="5"
                              ItemsSource="{Binding WorksheetNames}"
                              SelectedItem="{Binding SelectedWorksheetName, Mode=TwoWay}"/>

                    <Label Grid.Row="0" Grid.Column="2" Content="Header is on Row:" VerticalAlignment="Center"/>
                    <ComboBox Grid.Row="0" Grid.Column="3" Margin="5"
                              ItemsSource="{Binding AvailableHeaderRows}"
                              SelectedItem="{Binding HeaderRowNumber, Mode=TwoWay}"/>

                    <CheckBox Grid.Row="1" Grid.Column="0" Grid.ColumnSpan="4" Margin="0,10,0,0"
                              Content="Add auto-incrementing ID column as Primary Key"
                              IsChecked="{Binding AutoAddIdColumn, Mode=TwoWay}"/>
                </Grid>
            </GroupBox>

            <Button Content="Analyze Excel File" 
                    Command="{Binding AnalyzeCommand}" 
                    HorizontalAlignment="Center" 
                    Padding="10,5" 
                    Margin="0,15,0,15"
                    FontWeight="SemiBold"/>
        </StackPanel>

        <!-- This ScrollViewer will contain the schema grid and allow it to scroll without resizing the window -->
        <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto" HorizontalScrollBarVisibility="Disabled"
                      Visibility="{Binding IsSchemaReady, Converter={StaticResource BooleanToVisibilityConverter}}">
            <StackPanel>
                <!-- Step 3: Configure Schema -->
                <GroupBox Header="Step 3: Verify Column Schema" Padding="10">
                    <DataGrid ItemsSource="{Binding ProposedSchema}" 
                              AutoGenerateColumns="False" 
                              CanUserAddRows="False"
                              MaxHeight="400"
                              MaxWidth="750">
                        <DataGrid.Columns>
                            <DataGridTextColumn Header="Source (Excel)" Binding="{Binding SourceColumnName}" IsReadOnly="True" Width="2*"/>
                            <DataGridTextColumn Header="Destination (SQL)" Binding="{Binding DestinationColumnName}" Width="2*"/>
                            <DataGridTemplateColumn Header="Data Type" Width="1.5*">
                                <DataGridTemplateColumn.CellTemplate>
                                    <DataTemplate>
                                        <ComboBox ItemsSource="{Binding AvailableDataTypes}" 
                                                  SelectedItem="{Binding SelectedDataType, UpdateSourceTrigger=PropertyChanged}">
                                            <ComboBox.Style>
                                                <Style TargetType="ComboBox">
                                                    <Style.Triggers>
                                                        <!-- Disable the ComboBox if it's the auto-generated ID column -->
                                                        <DataTrigger Binding="{Binding SourceColumnName}" Value="ID (Auto-Generated)">
                                                            <Setter Property="IsEnabled" Value="False"/>
                                                        </DataTrigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </ComboBox.Style>
                                        </ComboBox>
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellTemplate>
                            </DataGridTemplateColumn>
                            <DataGridCheckBoxColumn Header="Primary Key?" Binding="{Binding IsPrimaryKey}" Width="Auto"/>
                        </DataGrid.Columns>
                    </DataGrid>
                </GroupBox>

                <!-- Step 4: Name Table -->
                <GroupBox Header="Step 4: Name Your New Table" Padding="10" Margin="0,15,0,0">
                    <TextBox Text="{Binding ProposedTableName, UpdateSourceTrigger=PropertyChanged}" VerticalContentAlignment="Center"/>
                </GroupBox>
            </StackPanel>
        </ScrollViewer>

        <!-- Final Action Buttons are in the last row -->
        <StackPanel Grid.Row="2" Orientation="Vertical" HorizontalAlignment="Stretch">
            <Separator Margin="0,20"/>
            <StackPanel Orientation="Horizontal" HorizontalAlignment="Right">
                <Button Content="Create Table" IsDefault="True" 
                        Command="{Binding CreateTableCommand}"
                        Width="100" Margin="0,0,10,0"
                        FontWeight="Bold"/>
                <Button Content="Cancel" IsCancel="True" Width="75"/>
            </StackPanel>
        </StackPanel>

    </Grid>
</Window>